export default class Importabular{constructor({data:t=[],node:i=null,onChange:h=null,minRows:e=1,maxRows:n=1/0,minCols:r=1,maxCols:o=1/0,css:l="",width:c="100%",height:a="80vh"}){if(!i)return console.error("Please call the constructor like this : new Importabular({node: document.body})");this.t=i,this.i={onChange:h,minRows:e,maxRows:n,minCols:r,maxCols:o,css:s+l},this.h={width:c,height:a,border:"none",background:"transparent"},this.o(),this.l(t),this.u({x:this.i.minCols-1,y:this.i.minRows-1}),this.m()}t=null;_=1;p=1;g=new _LooseArray;C({x:t,y:s}){return t>=0&&t<this.i.maxCols&&s>=0&&s<this.i.maxRows}m(){const t=Math.ceil(this.iframe.contentWindow.innerHeight/40),s=Math.ceil(this.iframe.contentWindow.innerWidth/100);this.u({x:s-1,y:t-1})}v(){this.i.onChange&&this.i.onChange(this.g.D())}k(t,s,i){const h=document.createElement("div");t.setAttribute("x",s.toString()),t.setAttribute("y",i.toString());const e=this.A(s,i);e?h.innerText=e:h.innerHTML="&nbsp;",t.appendChild(h),this.S({x:s,y:i})}o(){const t=document.createElement("iframe");this.iframe=t,this.t.appendChild(t);const s=t.contentWindow.document;this.cwd=s,s.open(),s.write(`<html lang="${navigator.language}"><body><style>${this.i.css}</style></body></html>`),s.close(),Object.assign(t.style,this.h);const i=document.createElement("table"),h=document.createElement("tbody");i.appendChild(h),s.body.appendChild(i),this.tbody=h,this.table=i;for(let t=0;t<this.p;t++){const s=document.createElement("tr");h.appendChild(s);for(let i=0;i<this._;i++)this.I(s,i,t)}this.T.forEach(t=>s.addEventListener(t,this[t],!0))}T=["mousedown","mouseenter","mouseup","mouseleave","touchstart","touchend","touchmove","keydown","paste","cut","copy"];destroy(){this.M(),this.T.forEach(t=>this.cwd.removeEventListener(t,this[t],!0)),this.iframe.parentElement.removeChild(this.iframe)}I(t,s,i){const h=document.createElement("td");t.appendChild(h),this.k(h,s,i)}V(){if(!this.C({x:0,y:this.p}))return!1;this.p++;const t=this.p-1,s=document.createElement("tr");this.tbody.appendChild(s);for(let i=0;i<this._;i++)this.I(s,i,t);return!0}L(){if(!this.C({x:this._,y:0}))return!1;this._++;const t=this._-1;return Array.prototype.forEach.call(this.tbody.children,(s,i)=>{this.I(s,t,i)}),!0}u({x:t,y:s}){for(;t>this._-1&&this.L(););for(;s>this.p-1&&this.V(););}paste=t=>{if(this.R)return;t.preventDefault();const s=function(t){try{const s=(t.clipboardData||window.clipboardData).getData("text/html"),i=document.createElement("iframe");document.body.appendChild(i),i.contentWindow.document.open(),i.contentWindow.document.write(s),i.contentWindow.document.close();const h=i.contentWindow.document.querySelectorAll("tr"),e=[];if(Array.prototype.forEach.call(h,(t,s)=>{const i=t.querySelectorAll("td");Array.prototype.forEach.call(i,(t,i)=>{const h=t.innerText;e[s]||(e[s]=[]),e[s][i]=h})}),document.body.removeChild(i),e.length)return e}catch(t){}return(t.clipboardData||window.clipboardData).getData("text").split(/\r\n|\n|\r/).map(t=>t.split(""))}(t),{rx:i,ry:h}=this.O,e={x:i[0],y:h[0]};for(let t=0;t<s.length;t++)for(let i=0;i<s[0].length;i++)this.j(e.x+i,e.y+t,s[t][i]);this.U(()=>{this.$=e,this.B={x:e.x+s[0].length-1,y:e.y+s.length-1}}),this.v()};H(){const{rx:t,ry:s}=this.O;if(t[0]===t[1])return null;const i=t[1]-t[0],h=s[1]-s[0],e=[];for(let n=0;n<h;n++){e.push([]);for(let h=0;h<i;h++)e[n].push(this.A(t[0]+h,s[0]+n))}return e}copy=t=>{if(this.R)return;const s=this.H();s&&(t.preventDefault(),t.clipboardData.setData("text/html",function(t){const s=document.createElement("table");return s.setAttribute("lang",navigator.language),t.forEach(t=>{const i=document.createElement("tr");s.appendChild(i),t.forEach(t=>{const s=document.createElement("td");i.appendChild(s),s.innerText=t})}),`<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"><html lang="${navigator.language}"><head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8"/><title></title></head><body>${s.outerHTML}</body></html>`}(s)),t.clipboardData.setData("text/plain",s.map(t=>t.join("")).join("\n")))};cut=t=>{this.R||(this.copy(t),this.P(""))};keydown=t=>{t.ctrlKey||this.$&&("Escape"===t.key&&this.R&&(t.preventDefault(),this.W(),this.N()),"Enter"===t.key&&(t.preventDefault(),this.q(!1,t.shiftKey?-1:1)),"Tab"===t.key&&(t.preventDefault(),this.q(!0,t.shiftKey?-1:1)),this.R||("Delete"!==t.key&&"Backspace"!==t.key||(t.preventDefault(),this.P("")),"ArrowDown"===t.key&&(t.preventDefault(),this.F({y:1},t.shiftKey)),"ArrowUp"===t.key&&(t.preventDefault(),this.F({y:-1},t.shiftKey)),"ArrowLeft"===t.key&&(t.preventDefault(),this.F({x:-1},t.shiftKey)),"ArrowRight"===t.key&&(t.preventDefault(),this.F({x:1},t.shiftKey))),1!==t.key.length||this.R||this.U(()=>{const{x:t,y:s}=this.Y;this.G({x:t,y:s}),this.J(t,s).firstChild.value=""}))};P(t){this.K(this.O,({x:s,y:i})=>this.j(s,i,t)),this.K(this.O,this.X),this.v()}F({x:t=0,y:s=0},i){const h=i?this.B:this.$,e={x:h.x+t,y:h.y+s};this.C(e)&&(this.N(),this.u(e),this.U(()=>{i?this.B=e:this.$=this.B=this.Y=e}),this.Z(e))}q(s,i=1){let{x:h,y:e}=this.Y||{x:0,y:0};const n=this.tt(),{rx:r,ry:o}=n>1?this.O:{rx:[0,this.i.maxCols],ry:[0,this.i.maxRows]};let l;if(s)l=t(h,e,i,r[0],r[1]-1,o[0],o[1]-1);else{const s=t(e,h,i,o[0],o[1]-1,r[0],r[1]-1);l={x:s.y,y:s.x}}this.C(l)&&(this.N(),this.u(l),this.U(()=>{this.Y=l,n<=1&&(this.$=this.B=l)}),this.Z(l))}Z({x:t,y:s}){this.J(t,s).scrollIntoView({behavior:"smooth",block:"nearest"})}st=!1;$=null;B=null;O={rx:[0,0],ry:[0,0]};R=null;Y=null;mousedown=t=>{if(!this.mobile){if(3===t.which&&!this.R&&this.tt()){let t=new Range;const{rx:s,ry:i}=this.O;return t.setStart(this.J(s[0],i[0]),0),t.setEnd(this.J(s[0],i[0]),1),this.cwd.getSelection().removeAllRanges(),void this.cwd.getSelection().addRange(t)}this.U(()=>{this.tbody.style.userSelect="none",this.B=this.$=this.Y=this.it(t),this.st=!0})}};mouseenter=t=>{this.mobile||this.st&&this.U(()=>{this.B=this.it(t)})};ht=null;et=null;nt(){this.st=!1,this.tbody.style.userSelect=""}mouseup=t=>{this.mobile||3!==t.which&&this.st&&this.U(()=>{this.B=this.it(t),this.nt(),this.ht&&this.ht>Date.now()-300&&this.et.x===this.B.x&&this.et.y===this.B.y&&this.G(this.B),this.ht=Date.now(),this.et=this.B})};mouseleave=t=>{t.target===this.tbody&&this.st&&this.nt()};touchstart=t=>{this.R||(this.mobile=!0,this.moved=!1)};touchend=t=>{this.mobile&&(this.R||this.moved||(this.U(()=>{this.B=this.$=this.Y=this.it(t)}),this.G(this.Y)))};touchmove=t=>{this.mobile&&(this.moved=!0)};G({x:t,y:s}){this.R={x:t,y:s};const i=this.J(t,s),h=i.getBoundingClientRect(),e=i.firstChild.getBoundingClientRect();Object.assign(i.style,{width:h.width-2,height:h.height}),i.removeChild(i.firstChild);const n=document.createElement("input");n.type="text",n.value=this.A(t,s),Object.assign(n.style,{width:e.width,height:e.height}),i.appendChild(n),n.focus(),n.addEventListener("blur",this.N),n.addEventListener("keydown",this.rt)}M(){if(this.R){const{x:t,y:s}=this.R,i=this.J(t,s).firstChild;i.removeEventListener("blur",this.N),i.removeEventListener("keydown",this.rt)}}W(){if(!this.R)return;const{x:t,y:s}=this.R;this.J(t,s).firstChild.value=this.A(t,s)}N=()=>{if(!this.R)return;const{x:t,y:s}=this.R,i=this.J(t,s);i.style.width="",i.style.height="";const h=i.firstChild;h.removeEventListener("blur",this.N),h.removeEventListener("keydown",this.rt),this.j(t,s,h.value),i.removeChild(h),this.R=null,this.k(i,t,s),this.v()};rt=t=>{13===t.keyCode&&(this.N(),t.preventDefault())};U(t){const s=this.O;t(),this.O=this.ot(),this.K(s,this.S),this.K(this.O,this.S)}ot(){if(!this.$)return{rx:[0,0],ry:[0,0]};let t=[this.$.x,this.B.x];t[0]>t[1]&&t.reverse();let s=[this.$.y,this.B.y];return s[0]>s[1]&&s.reverse(),{rx:[t[0],t[1]+1],ry:[s[0],s[1]+1]}}K({rx:t,ry:s},i){for(let h=t[0];h<t[1];h++)for(let t=s[0];t<s[1];t++)this.C({x:h,y:t})&&i({x:h,y:t})}S=({x:t,y:s})=>{this.J(t,s).className=this.lt(t,s)};tt(){const{rx:t,ry:s}=this.O;return(t[1]-t[0])*(s[1]-s[0])}lt(t,s){const{rx:i,ry:h}=this.O;let e="";return t>=i[0]&&t<i[1]&&s>=h[0]&&s<h[1]&&(e+=" selected",this.tt()>1&&(e+=" multi")),this.Y&&this.Y.x===t&&this.Y.y===s&&(e+=" focus"),this.R&&t===this.R.x&&s===this.R.y&&(e+=" editing"),e}X=({x:t,y:s})=>{const i=this.J(t,s).firstChild;"DIV"===i.tagName&&(i.innerText=this.A(t,s)),this.S({x:t,y:s})};it(t){let s=t.target;for(;!s.getAttribute("x")&&s.parentElement;)s=s.parentElement;return{x:parseInt(s.getAttribute("x"))||0,y:parseInt(s.getAttribute("y"))||0}}setData(t){this.g.ct(),this.l(t);for(let t=0;t<this._;t++)for(let s=0;s<this.p;s++)this.X({x:t,y:s})}getData(){return this.g.D()}l(t){t.forEach((t,s)=>{t.forEach((t,i)=>{this.j(i,s,t)})})}j(t,s,i){this.C({x:t,y:s})&&(this.g.j(t,s,i),this.u({x:t+1,y:s+1}),this.X({x:t,y:s}))}A(t,s){return this.g.A(t,s)}J(t,s){return this.tbody.children[s].children[t]}}class _LooseArray{g={};j(t,s,i){const h=this.g,e=function(t){return 0===t?"0":t?t.toString():""}(i);var n;e?(h[t]||(h[t]={}),h[t][s]=e):h[t]&&h[t][s]&&(delete h[t][s],n=h[t],0===Object.keys(n).length&&delete h[t])}ct(){this.g={}}A(t,s){const i=this.g;return i&&i[t]&&i[t][s]||""}D(){let t=1,s=1;for(let i in this.g)for(let h in this.g[i])s=Math.max(s,parseInt(h)+1),t=Math.max(t,parseInt(i)+1);const i=[];for(let h=0;h<s;h++){i.push([]);for(let s=0;s<t;s++)i[h].push(this.A(s,h))}return i}}function t(t,s,i,h,e,n,r){if((t+=i)<h){if(e===1/0)return{x:h,y:s};if(t=e,--s<n){if(r===1/0)return{x:h,y:n};s=r}}return t>e&&(t=h,++s>r&&(s=n,t=h)),{x:t,y:s}}const s="\nhtml{\n  -ms-overflow-style: none;\n  scrollbar-width: none;\n}\n::-webkit-scrollbar {\n  visibility: hidden;\n}\n*{\n  box-sizing: border-box;\n}\nbody{\n  padding: 0; \n  margin: 0;\n}\ntable{\n  border-spacing: 0;\n  background: white;\n  border: 1px solid #ddd;\n  border-width: 0 1px 1px 0;\n  font-size: 16px;\n  font-family: sans-serif;\n  border-collapse: separate;\n}\ntd{\n  padding:0;\n  border: 1px solid;\n  border-color: #ddd transparent transparent #ddd; \n}\ntd.selected.multi:not(.editing){\n  background:#d7f2f9;\n} \ntd.focus:not(.editing){\n  border-color: black;\n} \ntd>*{\n  border:none;\n  padding:10px;\n  min-width:100px;\n  min-height: 40px;\n  font:inherit;\n  line-height: 20px;\n  color:inherit;\n  white-space: normal;\n}\ntd>div::selection {\n    color: none;\n    background: none;\n}\n";
